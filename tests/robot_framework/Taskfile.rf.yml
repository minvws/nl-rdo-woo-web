# https://taskfile.dev
version: "3"

vars:
  URL_PUBLIC: '{{eq .ORBSTACK_ENABLED "1" | ternary .ORBSTACK_PUBLIC_URL "http://localhost:8000"}}'
  URL_ADMIN: '{{eq .ORBSTACK_ENABLED "1" | ternary .ORBSTACK_ADMIN_URL "http://localhost:8001/balie"}}'
  ROBOT_PARAMS: --outputdir results  --name 'E2E Tests' ./tests

env:
  VIRTUAL_ENV: ""
  URL_PUBLIC: '{{.URL_PUBLIC}}'
  URL_ADMIN: '{{.URL_ADMIN}}'

tasks:
  dependency:upgrade:
    desc: Upgrade all RF dependencies
    cmds:
     - uv lock --upgrade

  local:venv:
    desc: Create virtual environment
    cmds:
      - uv venv --clear
      - uv sync
      - uv run rfbrowser init

  local:init:
    desc: Initiates the local instance for the E2E tests.
    cmds:
      - task: fixtures:load:e2e
      - task: local:run
        vars:
          tag: init

  local:otp:
    desc: Returns an OTP code from the secret in .otp_secret
    cmds:
      - uv run python -c "import pyotp; print(pyotp.TOTP(open('.otp_secret').read().strip()).now())"

  local:run:
    aliases: [run-local]
    desc: Run Robot tests with browser on local
    env:
      ENVIRONMENT: local
      HEADLESS: false
    cmds:
      - task: :up
      - task: clear-results
      - task: disable-toolbar
      - cmd: uv run robot --include '{{.tag | default "single"}}' {{.ROBOT_PARAMS}}

  local:run:api:
    aliases: [run-api]
    desc: Run all API Robot tests
    env:
      ENVIRONMENT: local
      HEADLESS: true
    cmds:
      - task: :up
      - task: clear-results
      - task: disable-toolbar
      - cmd: uv run pabot --processes 8 --artifactsinsubfolders --include api {{.ROBOT_PARAMS}}

  local:run:mobile:
    desc: Run Robot tests with browser on Docker
    env:
      ENVIRONMENT: local
      HEADLESS: false
      DEVICE: iPhone 14
    cmds:
      - task: run-local
        env:
          tag: {{.tag}}

  docker:build:
    desc:
    cmds:
      - task: :dc
        vars: { SUB_CMD: "build robot" }

  docker:init:
    desc: Initiates the docker app for the E2E tests.
    cmds:
      - task: fixtures:load:e2e
      - touch .otp_secret
      - task: run-docker
        vars:
          tag: init

  docker:otp:
    desc: Returns an OTP code from the secret in .otp_secret
    cmds:
      - task: :dc
        vars: { SUB_CMD: "run --rm robot uv run python -c 'import pyotp; print(pyotp.TOTP(open(\".otp_secret\").read().strip()).now())'" }

  docker:run:
    aliases: [run-docker]
    desc: Run Robot Framework tests in headless mode inside a docker container
    cmds:
      - task: :up
      - task: clear-results
      - task: disable-toolbar
      - task: :dc
        vars:
          SUB_CMD: >
            run --rm robot
            /bin/bash -c "export PATH=/home/pwuser/.local/bin:/home/pwuser/.venv/bin:\$PATH &&
                          uv run robot --include '{{.tag | default "single"}}' {{.ROBOT_PARAMS}}"

  docker:run:ci:
    aliases: [run-ci]
    desc: Run all CI Robot tests with headless browser on Docker, parallel where possible.
    env:
      HEADLESS: true
    cmds:
      - task: :up
      - task: clear-results
      - task: disable-toolbar
      - task: :dc
        vars:
          SUB_CMD: >
            run --rm robot
            /bin/bash -c "export PATH=/home/pwuser/.local/bin:/home/pwuser/.venv/bin:\$PATH &&
                          uv run pabot --processes 8 --artifactsinsubfolders --outputdir results --include ci --exclude init --exclude sitemap --ordering order.txt {{.ROBOT_PARAMS}}"

  docker:run:api:
    aliases: [run-api]
    desc: Run all API Robot tests in docker
    env:
      HEADLESS: true
    cmds:
      - task: :up
      - task: clear-results
      - task: disable-toolbar
      - task: :dc
        vars:
          SUB_CMD: >
            run --rm robot
            /bin/bash -c "export PATH=/home/pwuser/.local/bin:/home/pwuser/.venv/bin:\$PATH &&
                          uv run pabot --processes 8 --artifactsinsubfolders --outputdir results --include api {{.ROBOT_PARAMS}}"

  docker:shell:
    cmds:
      - task: :dc
        vars:
          SUB_CMD: "run --rm robot /bin/bash"

  test:run:
    aliases: [run-test]
    desc: Run Robot tests with browser on TEST
    env:
      ENVIRONMENT: test
      URL_PUBLIC: https://web.test.woo.rdobeheer.nl
      URL_ADMIN: https://balie.test.woo.rdobeheer.nl/balie
      HEADLESS: false
    cmds:
      - uv run robot --include '{{.tag | default "testdossiers"}}' {{.ROBOT_PARAMS}}

  acc:run:
    aliases: [run-acc]
    desc: Run Robot tests with browser on ACC
    env:
      ENVIRONMENT: acc
      URL_PUBLIC: https://web.acc.woo.irealisatie.nl
      URL_ADMIN: https://balie.acc.woo.irealisatie.nl/balie
      HEADLESS: false
    cmds:
      - uv run robot --include '{{.tag | default "testdossiers"}}' {{.ROBOT_PARAMS}}

  lint:
    desc: Run Robocop linter
    cmds:
      - uv run robocop check

  format:
    desc: Run Robocop format
    cmds:
      - uv run robocop format

  cleansheet:
    desc: Run for Robot customized cleansheet
    cmds:
      - task: :dc:shell
        vars: { SUB_CMD: "admin bin/console woopie:dev:clean-sheet --force {{.CLI_ARGS}}" }
      - task: :minio:clear-buckets

  fixtures:load:vws:
    desc: Load the VWS fixtures, used by the Covid19 theme page
    internal: true
    cmds:
      - task: :dc:shell
        vars: { SUB_CMD: "admin bin/console doctrine:fixtures:load --no-interaction --append --group=vws" }

  fixtures:load:e2e:
    desc: Load the E2E fixtures
    cmds:
      - task: :dc:shell
        vars: { SUB_CMD: "admin bin/console doctrine:fixtures:load --no-interaction --append --group=e2e" }

  clear-results:
    desc: Empties the results folder, as well as creating it if it does not exist
    internal: true
    cmds:
      - cmd: mkdir -p results
      - cmd: rm -rf results/*

  disable-toolbar:
    desc: Disable the Symfony debug toolbar in Robot Framework tests
    dir: ../../
    status:
      - test ! -f {{.BASE_PATH}}/.env.local
    cmds:
      - cmd: sed -i '' 's/^\(ENABLE_TOOLBAR=\).*$/\1false/' .env.local
        platforms: [darwin]
      - cmd: sed -i 's/^\(ENABLE_TOOLBAR=\).*$/\1false/' .env.local
        platforms: [linux]
