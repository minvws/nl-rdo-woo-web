# https://taskfile.dev
version: "3"

tasks:
  venv:
    desc: Create virtual environment
    dir: ../../
    cmds:
      - python3 -m venv .venv --clear --upgrade-deps
      - source .venv/bin/activate && pip install -r tests/robot_framework/requirements.txt  --use-feature=truststore
      - source .venv/bin/activate && rfbrowser init

  dependency:upgrade:
    desc: Upgrade all RF dependencies
    cmds:
     - pip-compile --upgrade --output-file=requirements.txt requirements.in

  init:
    desc: Initiates your local app for the E2E tests. Run after a `task reset` or your initial setup.
    dir: ../../
    cmds:
      - task: fixtures:load:e2e
      - task: run-local
        vars:
          tag: init

  run-local:
    desc: Run Robot tests with browser on Docker
    dir: ../../
    env:
      URL_PUBLIC: http://localhost:8000
      URL_ADMIN: http://localhost:8000/balie
      HEADLESS: false
    cmds:
      - task: :up
      - source .venv/bin/activate && robot --outputdir tests/robot_framework/results --include '{{.tag}}' --variable ENVIRONMENT:docker-local tests/robot_framework

  run-test:
    aliases: [run-tst]
    desc: Run Robot tests with browser on TEST
    dir: ../../
    env:
      URL_PUBLIC: https://web.test.woo.rdobeheer.nl
      URL_ADMIN: https://balie.test.woo.rdobeheer.nl/balie
      HEADLESS: false
    cmds:
      - source .venv/bin/activate && robot --outputdir tests/robot_framework/results --include '{{.tag}}' --variable ENVIRONMENT:test tests/robot_framework

  run-acc:
    desc: Run Robot tests with browser on ACC
    dir: ../../
    env:
      URL_PUBLIC: https://web.acc.woo.irealisatie.nl
      URL_ADMIN: https://balie.acc.woo.irealisatie.nl/balie
      HEADLESS: false
    cmds:
      - source .venv/bin/activate && robot --outputdir tests/robot_framework/results --include '{{.tag}}' --variable ENVIRONMENT:acc tests/robot_framework

  run-mobile:
    desc: Run Robot tests with browser on Docker
    dir: ../../
    env:
      URL_PUBLIC: http://localhost:8000
      URL_ADMIN: http://localhost:8000/balie
      HEADLESS: false
      DEVICE: iPhone 14
    cmds:
      - task: :up
      - source .venv/bin/activate && robot --outputdir tests/robot_framework/results --include '{{.tag}}' --variable ENVIRONMENT:docker-local tests/robot_framework

  run-ci-sequential:
    desc: Run all CI Robot tests with headless browser on Docker, parallel where possible.
    dir: ../../
    env:
      URL_PUBLIC: http://localhost:8000
      URL_ADMIN: http://localhost:8000/balie
      HEADLESS: true
    cmds:
      - task: :up
      - source .venv/bin/activate && robot --outputdir tests/robot_framework/results --include '{{ .tag | default "ci" }}' --exclude 'init' --variable ENVIRONMENT:docker-local tests/robot_framework

  run-ci-parallel:
    aliases: [run-ci]
    desc: Run all CI Robot tests with headless browser on Docker, parallel where possible.
    dir: ../../
    env:
      URL_PUBLIC: http://localhost:8000
      URL_ADMIN: http://localhost:8000/balie
      HEADLESS: true
    cmds:
      - task: :up
      - cmd: source .venv/bin/activate && pabot --processes 8 --outputdir tests/robot_framework/results --output output-pabot.xml --log NONE --report NONE  --include 'parallel' --variable ENVIRONMENT:docker-local tests/robot_framework
        ignore_error: true
      - source .venv/bin/activate && rebot --output tests/robot_framework/results/output-pabot.xml --log NONE --report NONE --name 'Parallel run' --nostatusrc tests/robot_framework/results/output-pabot.xml
      - cmd: source .venv/bin/activate && robot --outputdir tests/robot_framework/results --output output-robot.xml --log NONE --report NONE --name 'Sequential run' --include 'ci' --exclude 'parallel' --exclude 'init' --variable ENVIRONMENT:docker-local tests/robot_framework
        ignore_error: true
      - source .venv/bin/activate && rebot --output tests/robot_framework/results/output.xml --name 'Robot Framework' --log tests/robot_framework/results/log.html --report tests/robot_framework/results/report.html --nostatusrc tests/robot_framework/results/output-robot.xml tests/robot_framework/results/output-pabot.xml

  check:
    desc: Run Robocop check
    dir: ../../
    cmds:
      - source .venv/bin/activate && robocop check --config tests/robot_framework/pyproject.toml

  format:
    desc: Run Robocop format
    dir: ../../
    cmds:
      - source .venv/bin/activate && robocop format --config tests/robot_framework/pyproject.toml

  cleansheet:
    desc: Run for Robot customized cleansheet
    cmds:
      - task: :dc:shell
        vars: { CLI_ARGS: "app bin/console woopie:dev:clean-sheet --force {{.CLI_ARGS}}" }
      - task: :minio:clear-buckets

  sitemap:
    desc: Generate the sitemap in one command
    cmds:
      - task: :app:generate-sitemap

  fixtures:load:vws:
    desc: Load the VWS fixtures, used by the Covid19 theme page
    cmds:
      - task: :dc:shell
        vars: { CLI_ARGS: "app bin/console doctrine:fixtures:load --no-interaction --append --group=vws" }

  fixtures:load:e2e:
    desc: Load the E2E fixtures
    cmds:
      - task: :dc:shell
        vars: { CLI_ARGS: "app bin/console doctrine:fixtures:load --no-interaction --append --group=e2e" }
